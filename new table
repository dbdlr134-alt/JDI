use dictionary;

-- 테이블 새로 생성 (point_id 제거, 외래키 추가)
CREATE TABLE jdi_point_log (
    jdi_user   VARCHAR(50) NOT NULL,           -- 회원ID (외래키)
    amount     INT NOT NULL default 0,      -- 포인트 양
    reason     VARCHAR(100),                   -- 사유
    reg_date   DATETIME DEFAULT NOW(),         -- 날짜
    
    -- [외래키 설정] jdi_login 테이블의 jdi_user를 참조함
    -- ON DELETE CASCADE: 회원이 탈퇴하면 포인트 기록도 같이 삭제됨
    FOREIGN KEY (jdi_user) REFERENCES jdi_login(jdi_user) ON DELETE CASCADE
);

-- (테스트용) 가입 축하금 다시 넣기
INSERT INTO jdi_point_log (jdi_user, amount, reason) 
VALUES ('dbdlr134', 1000, '회원가입 축하금');

select * from jdi_point_log;

CREATE TABLE jdi_word_req (
    req_id     INT AUTO_INCREMENT PRIMARY KEY, -- 신청 번호
    word       VARCHAR(50) NOT NULL,           -- 단어
    doc        VARCHAR(100),                   -- 요미가나
    korean     VARCHAR(200) NOT NULL,          -- 뜻
    jlpt       VARCHAR(10) DEFAULT 'N5',       -- 급수
    jdi_user   VARCHAR(50),                    -- 신청자 ID (외래키)
    status     VARCHAR(10) DEFAULT 'WAIT',     -- 상태 (WAIT:대기, OK:승인, NO:거절)
    reg_date   DATETIME DEFAULT NOW(),         -- 신청일
    
    FOREIGN KEY (jdi_user) REFERENCES jdi_login(jdi_user) ON DELETE SET NULL
);

cREATE TABLE incorrect_note (
    note_id INT AUTO_INCREMENT PRIMARY KEY,   -- 오답노트 고유 번호
    jdi_user VARCHAR(50) NOT NULL,            -- 틀린 사람
    quiz_id INT NOT NULL,                     -- 틀린 문제
    wrong_date DATETIME DEFAULT NOW(),        -- 마지막으로 틀린 날짜
    wrong_count INT DEFAULT 1,                -- ★ 추가됨: 틀린 횟수 (기본 1)
    
    CONSTRAINT fk_note_user FOREIGN KEY (jdi_user) REFERENCES jdi_login (jdi_user) ON DELETE CASCADE,
    CONSTRAINT fk_note_quiz FOREIGN KEY (quiz_id) REFERENCES jquiz (quiz_id) ON DELETE CASCADE,
    UNIQUE KEY (jdi_user, quiz_id)
);

-- 수정 신청 테이블
CREATE TABLE jdi_word_edit_request (
    req_id INT AUTO_INCREMENT PRIMARY KEY,
    word_id INT NOT NULL,          -- 수정 요청할 단어 ID
    jdi_user VARCHAR(50) NOT NULL, -- 신청자
    word       VARCHAR(50) NOT NULL,           -- 단어
    doc VARCHAR(100),              -- 수정 요청 음독/읽기
    korean VARCHAR(500),           -- 수정 요청 뜻
    jlpt VARCHAR(10),              -- 수정 요청 JLPT
    status VARCHAR(10) DEFAULT 'WAIT', -- WAIT / OK / NO
    reg_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 사용자가 푼 문제 수를 저장할 컬럼 추가 (기본값 0)
ALTER TABLE jdi_login ADD jdi_solve_count INT DEFAULT 0;

CREATE TABLE profile_request (
    req_id     INT AUTO_INCREMENT PRIMARY KEY,
    user_id    VARCHAR(50) NOT NULL,
    image_path VARCHAR(255) NOT NULL,
    comment    VARCHAR(500),
    status     VARCHAR(20) DEFAULT 'PENDING',
    req_date   DATETIME DEFAULT NOW()
);
